<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PME Inteligente: Gest√£o Simplificada 360¬∞</title> 
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--azul:#2a4fda;--atl:#0b2574;--off:#eff3ee;--bg:#ffffff;--txt:#0f172a;--mut:#64748b;--b:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;--shadow:0 8px 24px rgba(2,6,23,.06)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt)}
header{background:linear-gradient(90deg,var(--azul),var(--atl));color:#fff;padding:22px 18px;box-shadow:var(--shadow); text-align: center;}
h1{margin:0;font-weight:800;letter-spacing:-.3px}
small{opacity:.9}
.container{max-width:1200px;margin:18px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:18px;box-shadow:var(--shadow);padding:14px}
.grid{display:grid;gap:14px}
@media(min-width:920px){.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:2fr 1fr}.cols-2e{grid-template-columns:1fr 1fr}}
.toolbar{display:flex;flex-wrap:wrap;gap:10px}
.input,select,button{border:1px solid var(--b);border-radius:12px;padding:10px 12px;background:#fff}
label{font-size:13px;color:var(--mut)}
.pill{display:flex;align-items:center;gap:10px;border:1px solid var(--b);border-radius:999px;background:var(--off);padding:8px 12px}
.badge{font-size:12px;border:1px solid var(--b);border-radius:999px;padding:5px 10px;background:var(--off);color:#111}
.kpi{display:flex;gap:10px;align-items:flex-start}
.kpi .dot{width:14px;height:14px;border-radius:50%}
.kpi h3{margin:0;font-size:13px;color:var(--mut)}
.kpi .value{font-size:28px;font-weight:800;letter-spacing:-.4px}
.hint{font-size:12px;color:var(--mut);margin-top:6px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.legend{display:flex;gap:10px;flex-wrap:wrap}
.legend span{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--mut)}
.legend i{width:10px;height:10px;border-radius:2px;display:inline-block}
.insights{display:grid;gap:10px}
@media(min-width:900px){.insights{grid-template-columns:1fr 1fr}}
.insight{border-left:6px solid var(--azul);background:#f8fafc;border:1px solid var(--b);padding:10px 12px;border-radius:12px}
.insight strong{display:block;margin-bottom:4px}
.insight.warn{border-left-color:var(--warn);background:#fff7ed}
.insight.bad{border-left-color:var(--bad);background:#fef2f2}
.insight.ok{border-left-color:var(--ok);background:#f0fdf4}
.item{border:1px solid var(--b);border-radius:12px;padding:10px;background:#fafafa}
.list{display:grid;gap:10px}
code{background:#f1f5f9;border:1px solid var(--b);padding:2px 6px;border-radius:6px}
hr{border:none;border-top:1px solid var(--b);margin:8px 0}
footer{padding:24px;color:#6b7280;text-align:center}
.hidden{display:none !important}
.range{display:grid;gap:6px}
.range label{font-size:12px;color:var(--mut)}
.range input{width:100%}
.mut{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>PME Inteligente: Gest√£o Simplificada 360¬∞</h1>
  <small>Intelig√™ncia de Dados para o Seu Dia a Dia.</small> 
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div class="toolbar" style="flex-wrap:wrap">
        <input id="csvUrl" class="input" style="min-width:420px" placeholder="Cole aqui a URL CSV do seu Google Sheets...">
        <button id="btnCarregar">Carregar Dados</button>
        <input id="fileInput" class="input" type="file" accept=".csv">
        <div class="pill">
          <label>Per√≠odo</label>
          <select id="period"><option value="30">√öltimos 30 dias</option><option value="90">√öltimos 90 dias</option><option value="365">√öltimos 12 meses</option></select>
        </div>
        <div class="pill">
          <label>Meta mensal (R$)</label>
          <input id="meta" class="input" type="number" step="100" value="15000">
        </div>
      </div>
      <div class="row" style="gap:8px">
        <button id="btnRegistrar" class="input">Registrar a√ß√£o</button>
        <button id="btnMeta" class="input">Atualizar meta</button>
      </div>
    </div>
  </div>

  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotFat" class="dot"></span><div><h3>üí∞ Faturamento (per√≠odo)</h3><div id="kpiFat" class="value">‚Äî</div><div id="descFat" class="hint">‚Äî</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotCli" class="dot"></span><div><h3>üë• Clientes</h3><div id="kpiCli" class="value">‚Äî</div><div id="descCli" class="hint">‚Äî</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotTicket" class="dot"></span><div><h3>üßæ Ticket m√©dio</h3><div id="kpiTicket" class="value">‚Äî</div><div id="descTicket" class="hint">‚Äî</div></div></div></div>
  </section>
  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotMargem" class="dot"></span><div><h3>üìà Margem (%)</h3><div id="kpiMargem" class="value">‚Äî</div><div id="descMargem" class="hint">‚Äî</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotMC" class="dot" style="background:var(--azul)"></span><div><h3>üí∏ Margem Contribui√ß√£o</h3><div id="kpiMC" class="value">‚Äî</div><div id="descMC" class="hint">‚Äî</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotCAC" class="dot" style="background:var(--warn)"></span><div><h3>üë§ Custo/Cliente (CAC)</h3><div id="kpiCAC" class="value">‚Äî</div><div id="descCAC" class="hint">‚Äî</div></div></div></div>
  </section>
  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotCustos" class="dot"></span><div><h3>üíº Custos (% vendas)</h3><div id="kpiCustos" class="value">‚Äî</div><div id="descCustos" class="hint">‚Äî</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotMeta" class="dot"></span><div><h3>üéØ Meta atingida (%)</h3><div id="kpiMeta" class="value">‚Äî</div><div id="descMeta" class="hint">‚Äî</div></div></div></div>
  </section>

  <section class="grid cols-2" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>Evolu√ß√£o semanal de vendas</strong><span id="trendInfo" class="badge">‚Äî</span></div>
      <canvas id="chartVendas" height="120"></canvas>
    </div>
    <div class="card">
      <div class="row"><strong>Desempenho de Margem e Custo (Lucratividade)</strong><span class="badge">√öltimos Per√≠odos</span></div>
      <canvas id="chartMargemCusto" height="120"></canvas>
    </div>
  </section>

  <section class="grid cols-2e" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>üîé O que os dados dizem agora</strong><span class="mut">(gerado automaticamente)</span></div>
      <div id="insights" class="insights" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="row"><strong>üß≠ O que voc√™ pode fazer</strong><span class="mut">(recomenda√ß√µes pr√°ticas)</span></div>
      <div id="recos" class="list" style="margin-top:10px"></div>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row"><strong>üß™ Simulador ‚Äúe se eu‚Ä¶‚Äù</strong><span class="mut">(impacto estimado no m√™s)</span></div>
    <div class="grid cols-3" style="margin-top:8px">
      <div class="range">
        <label>‚úèÔ∏è Ajustar ticket m√©dio (+R$) <span id="simTicketVal" class="badge">+0</span></label>
        <input id="simTicket" type="range" min="0" max="10" step="1" value="0">
      </div>
      <div class="range">
        <label>üì£ Aumentar clientes/dia (+) <span id="simClientesVal" class="badge">+0</span></label>
        <input id="simClientes" type="range" min="0" max="20" step="1" value="0">
      </div>
      <div class="range">
        <label>üîß Reduzir custos (%) <span id="simCustosVal" class="badge">0%</span></label>
        <input id="simCustos" type="range" min="0" max="10" step="1" value="0">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div id="simResultado" class="pill">üìä Resultado simulado: ‚Äî</div>
      <button id="btnPlano" class="input">Gerar plano de a√ß√£o</button>
    </div>
  </section>

  <section class="grid cols-2e" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>üìÖ √öltimas a√ß√µes registradas</strong><span id="logInfo" class="mut">‚Äî</span></div>
      <div class="list" style="margin-top:10px" id="logAcoes">
        </div>
    </div>
    <div class="card">
      <div class="row"><strong>‚è∞ Rotina sugerida</strong><span class="mut">(para criar h√°bito)</span></div>
      <ul id="rotinaSugerida">
        <li>Diariamente (19h): registrar vendas (30s)</li>
        <li>Segunda: revisar painel e definir 1 a√ß√£o</li>
        <li>√öltimo dia do m√™s: ajustar meta</li>
      </ul>
      <div class="row" style="gap:8px"><button id="btnLembrete" class="input">Criar lembrete</button><button id="btnForm" class="input">Abrir formul√°rio di√°rio</button></div>
    </div>
  </section>

</div>

<footer>
  ¬© 2025 Painel PME Inteligente - Grupo 3 (Julio Volpatto, Rodrigo Santos e Mariana Santana)
</footer>

<script>
let DATA=[], chartVendas=null, chartMargemCusto=null; 
const elUrl = document.getElementById('csvUrl');
const elMeta = document.getElementById('meta');
const elPeriod = document.getElementById('period');
const elFile = document.getElementById('fileInput');

// L√≥gica de armazenamento local para A√ß√µes Registradas
function carregarAcoes() {
    try {
        const json = localStorage.getItem('pme_acoes');
        return json ? JSON.parse(json) : [];
    } catch (e) {
        console.error("Erro ao carregar a√ß√µes:", e);
        return [];
    }
}

function salvarAcao(acao) {
    const acoes = carregarAcoes();
    acao.id = Date.now();
    acao.data = new Date().toLocaleDateString('pt-BR');
    acao.status = 'em execu√ß√£o';
    acoes.unshift(acao); 
    localStorage.setItem('pme_acoes', JSON.stringify(acoes.slice(0, 5))); // Guarda apenas as 5 mais recentes
}

function removerAcao(id) {
    let acoes = carregarAcoes();
    // Simplesmente remove a a√ß√£o
    acoes = acoes.filter(acao => acao.id != id);
    localStorage.setItem('pme_acoes', JSON.stringify(acoes));
    atualizarLogAcoes();
}

function atualizarLogAcoes() {
    const logAcoesEl = document.getElementById('logAcoes');
    const acoes = carregarAcoes();
    logAcoesEl.innerHTML = '';
    
    if (acoes.length === 0) {
        logAcoesEl.innerHTML = '<div class="item mut" style="text-align:center;">Nenhuma a√ß√£o registrada ainda.</div>';
        document.getElementById('logInfo').textContent = '(Vazio)';
        return;
    }

    acoes.forEach(acao => {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        // Adiciona o bot√£o de remo√ß√£o/conclus√£o
        const statusText = acao.status === 'em execu√ß√£o' ? '<span class="badge" style="background:var(--warn)">Em Execu√ß√£o</span>' : '<span class="badge" style="background:var(--ok)">Conclu√≠do</span>';
        
        itemEl.innerHTML = `
            <div class="row">
                <strong>${acao.nome}</strong>
                <button class="input" style="padding: 4px 8px; font-size: 11px;" onclick="removerAcao(${acao.id})">Remover/Concluir</button>
            </div>
            <div class="hint" style="margin-top:4px; font-size: 11px;">Iniciado ${acao.data} ‚Ä¢ Status: ${acao.status}</div>
        `;
        logAcoesEl.appendChild(itemEl);
    });
    document.getElementById('logInfo').textContent = `(Total: ${acoes.length} a√ß√µes)`;
}

// Helpers
function parseNumberBR(s){
  if (typeof s === 'number') return s;
  if (!s) return 0;
  const t = (''+s).trim().replace(/\s/g,''); 
  const norm = t.match(/,\d{1,2}$/) ? t.replace(/\./g,'').replace(',', '.') : t;
  const v = parseFloat(norm);
  return isNaN(v) ? 0 : v;
}
function fmtBR(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }
function setDot(el, pct){ el.style.background = pct>=0.95? 'var(--ok)' : pct>=0.85? 'var(--warn)' : 'var(--bad)'; }
function csvToRows(csv){
  const rows=[]; let i=0, field=''; let row=[]; let quoted=false; 
  const s=csv.replace(/\r/g,''); 
  while(i<s.length){
    const c=s[i];
    if(c==='\"'){ if(quoted && s[i+1]==='\"'){ field+='\"'; i++; } else { quoted=!quoted; } }
    else if(c===',' && !quoted){ row.push(field); field=''; }
    else if(c==='\n' && !quoted){ row.push(field); rows.push(row); row=[]; field=''; }
    else { field+=c; }
    i++;
  }
  if(field.length||row.length){ row.push(field); rows.push(row); }
  return rows;
}
async function fetchCSV(url){ const res = await fetch(url); if(!res.ok) throw new Error('Falha ao acessar CSV'); return await res.text(); }

function parseDateBR(dateStr){
    if (!dateStr || dateStr.length < 8) return null;
    // Tenta DD/MM/AAAA (padr√£o brasileiro)
    if (dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/)) {
        const parts = dateStr.split('/');
        // JS usa Date(YYYY, MM-1, DD)
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    // Tenta AAAA-MM-DD ou formato ISO (padr√£o universal/CSV)
    const d = new Date(dateStr);
    return isNaN(d.getTime()) ? null : d;
}

function hydrate(rows){
  const head = rows.shift().map(h=>h.trim());
  const idx = {
    Data: head.indexOf('Data'), Valor: head.indexOf('Valor'), Clientes: head.indexOf('Clientes'),
    Produto: head.indexOf('Produto'), Categoria: head.indexOf('Categoria'),
    CF: head.indexOf('CustosFixos'), CV: head.indexOf('CustosVariaveis'), MetaMensal: head.indexOf('MetaMensal')
  };
  const arr = rows.map(r=>({
    data: parseDateBR(r[idx.Data]),
    valor: parseNumberBR(r[idx.Valor]),
    clientes: parseInt(r[idx.Clientes]||'0',10)||0,
    produto: idx.Produto>=0? r[idx.Produto] : '',
    categoria: idx.Categoria>=0? r[idx.Categoria] : '',
    cf: idx.CF>=0? parseNumberBR(r[idx.CF]) : null,
    cv: idx.CV>=0? parseNumberBR(r[idx.CV]) : null,
    metaRow: idx.MetaMensal>=0? parseNumberBR(r[idx.MetaMensal]) : null
  })).filter(x=>x.data && !isNaN(x.data.getTime())); 
  
  return arr.sort((a,b)=>a.data-b.data);
}

// =========================================================================
// FUN√á√ïES DE A√á√ÉO (RESOLVEM O ReferenceError DE ORDEM)
// =========================================================================

function createWeeklyICS(){
  const now = new Date();
  const day = now.getDay(); // 0=dom
  const diff = ((1 - day + 7) % 7) || 7; 
  const nextMon = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff, 9, 0, 0);
  function toICSDate(d){
    const pad = n => String(n).padStart(2,'0');
    return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate()) + 'T' + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';
  }
  
  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//PME Inteligente//NONSGML v1.0//EN',
    'BEGIN:VEVENT',
    'UID:' + Date.now() + '@pmeinteligente.com.br',
    'DTSTAMP:' + toICSDate(now),
    'DTSTART:' + toICSDate(nextMon),
    'DTEND:' + toICSDate(new Date(nextMon.getTime() + 30*60000)), // Dura√ß√£o de 30 minutos
    'RRULE:FREQ=WEEKLY;INTERVAL=1;BYDAY=MO', // Repetir toda segunda-feira
    'SUMMARY:Revis√£o Semanal Painel PME (Decis√£o Guiada)',
    'DESCRIPTION:Revisar KPIs, analisar Insights e definir 1 a√ß√£o de melhoria. N√£o se esque√ßa de registrar as vendas di√°rias!',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\n');

  const blob = new Blob([icsContent], {type: 'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Lembrete_PME_Semanal.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function openDailyForm(){
  const url = 'https://docs.google.com/forms/d/e/1FAIpQLSdOnLyR3-TjKrpPKuItqBzeKkiu9OO3OX6Z5ZnfIBd4wVe41g/viewform?usp=header';
  window.open(url, '_blank');
}

// Fun√ß√£o placeholder para gerar plano de a√ß√£o (agora recebe o tipo)
function generateActionPlan(options){
    const { tipo } = options;
    const simResultado = document.getElementById('simResultado').textContent;
    let plano = `Plano de A√ß√£o (Gerado em ${new Date().toLocaleDateString('pt-BR')})\n\n`;

    if (tipo === 'simulacao') {
        plano += 'OBJETIVO: Validar estrat√©gia de simula√ß√£o.\n';
        plano += `RESULTADO ESPERADO: ${simResultado}\n\n`;
        plano += 'PASSOS DE EXECU√á√ÉO:\n';

        const simTicketVal = parseInt(document.getElementById('simTicket').value);
        const simClientesVal = parseInt(document.getElementById('simClientes').value);
        const simCustosVal = parseInt(document.getElementById('simCustos').value);

        if (simTicketVal > 0) {
            plano += `* Aumentar Ticket M√©dio em R$${simTicketVal} (A√ß√£o: Treinamento de venda complementar ou Combo de produtos).\n`;
        }
        if (simClientesVal > 0) {
            plano += `* Aumentar Clientes/Dia em ${simClientesVal} (A√ß√£o: Campanha de atra√ß√£o ou Promo√ß√£o rel√¢mpago).\n`;
        }
        if (simCustosVal > 0) {
            plano += `* Reduzir Custos em ${simCustosVal}% (A√ß√£o: Renegocia√ß√£o de fornecedores ou Otimiza√ß√£o de processos internos).\n`;
        }
        
        plano += '\nCHECKLIST DE ACOMPANHAMENTO:\n';
        plano += '- [ ] Comunicar a meta para a equipe\n';
        plano += '- [ ] Iniciar as a√ß√µes acima\n';
        plano += '- [ ] Monitorar o Painel diariamente\n';
        plano += '- [ ] Ajustar a estrat√©gia em 7 dias\n';
        
        salvarAcao({nome: `Simula√ß√£o: ${simTicketVal > 0 ? 'Ticket' : ''}${simClientesVal > 0 ? ' Clientes' : ''}${simCustosVal > 0 ? ' Custos' : ''}`.trim()});

    } else if (tipo === 'manual') {
        const nomeAcao = prompt("Qual o nome da a√ß√£o que voc√™ est√° registrando?");
        if (!nomeAcao) return;
        plano += 'OBJETIVO: A√ß√£o manual registrada no log.\n';
        plano += `A√á√ÉO REGISTRADA: ${nomeAcao}\n\n`;
        plano += 'PASSOS DE EXECU√á√ÉO:\n';
        plano += '* Descreva os passos detalhados para esta a√ß√£o.\n';
        
        salvarAcao({nome: nomeAcao});
    }

    const blob = new Blob([plano], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Plano_de_Acao.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    atualizarLogAcoes();
    alert('Plano de A√ß√£o gerado e baixado como Plano_de_Acao.txt!');
}

// =========================================================================
// L√ìGICA DE C√ÅLCULO
// =========================================================================

function calcular() {
    const metaMensal = parseNumberBR(elMeta.value) || 0;
    const periodo = parseInt(elPeriod.value);
    const endDate = new Date(DATA[DATA.length - 1].data);
    const startDate = new Date(endDate.getTime() - (periodo - 1) * 24 * 60 * 60 * 1000);

    const filtered = DATA.filter(d => d.data >= startDate);
    
    // 1. C√°lculos de Agrega√ß√£o
    const fat = filtered.reduce((sum, d) => sum + d.valor, 0);
    const clientes = filtered.reduce((sum, d) => sum + d.clientes, 0);
    const custoFixo = filtered.reduce((sum, d) => sum + (d.cf === null ? 0 : d.cf), 0) / (periodo/30);
    const custoVariavel = filtered.reduce((sum, d) => sum + (d.cv === null ? 0 : d.cv), 0);
    
    // Custos totais
    const custosTotais = custoFixo + custoVariavel;

    // M√©tricas
    const ticketMedio = clientes > 0 ? fat / clientes : 0;
    const margemCont = fat - custoVariavel; // Margem de Contribui√ß√£o: (Vendas - Custo Vari√°vel)
    const lucro = fat - custosTotais;
    const margemPct = fat > 0 ? (lucro / fat) : 0;
    const custoPct = fat > 0 ? (custosTotais / fat) : 0;
    const metaPct = metaMensal > 0 ? (fat / metaMensal) : 0;
    const cac = clientes > 0 ? custoFixo / clientes : 0;
    
    // C√°lculo da Varia√ß√£o Semanal (Trend)
    const hoje = new Date();
    const last7Days = DATA.filter(d => d.data >= new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000));
    const prior7Days = DATA.filter(d => d.data >= new Date(hoje.getTime() - 14 * 24 * 60 * 60 * 1000) && d.data < new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000));
    
    const fatLast7 = last7Days.reduce((sum, d) => sum + d.valor, 0);
    const fatPrior7 = prior7Days.reduce((sum, d) => sum + d.valor, 0);
    
    let trend = 0;
    if (fatPrior7 > 0) {
        trend = (fatLast7 - fatPrior7) / fatPrior7;
    } else if (fatLast7 > 0) {
        trend = 1; // Se faturamento anterior era 0 e agora √© positivo
    }

    // 2. C√°lculo da Simula√ß√£o
    function simular(simTicket, simClientes, simCustos){
        // Valores ajustados
        const novoTicket = ticketMedio + simTicket;
        const novosClientes = clientes + (simClientes * (periodo / 30)); 
        const novoCustoFixo = custoFixo * (1 - simCustos/100); 

        // Novo Faturamento (assumindo que o ticket se aplica a todos os clientes)
        const novoFat = novosClientes * novoTicket * (periodo / (clientes/fat*periodo));
        
        // Novo Custo Total
        const novoCustosTotais = novoCustoFixo + custoVariavel;
        
        // Novo Lucro
        const novoLucro = novoFat - novoCustosTotais;
        const novaMargemPct = novoFat > 0 ? (novoLucro / novoFat) : 0;
        const novaMetaPct = metaMensal > 0 ? (novoFat / metaMensal) : 0;

        return {
            novoFat: novoFat,
            novoLucro: novoLucro,
            novaMargemPct: novaMargemPct,
            novaMetaPct: novaMetaPct
        };
    }

    return { fat, clientes, ticketMedio, margemCont, lucro, margemPct, custoPct, metaPct, cac, trend, custosTotais, simular, metaMensal, filtered, custoFixo, custoVariavel };
}

function atualizar() {
    if (DATA.length === 0) return;
    
    const { fat, clientes, ticketMedio, margemCont, lucro, margemPct, custoPct, metaPct, cac, trend, custosTotais, simular, metaMensal, filtered, custoFixo, custoVariavel } = calcular();
    const periodo = parseInt(elPeriod.value);
    
    // 1. Atualizar KPIs
    document.getElementById('kpiFat').textContent = fmtBR(fat);
    setDot(document.getElementById('dotFat'), trend + 1);
    document.getElementById('descFat').textContent = `Total em ${periodo} dias`;

    document.getElementById('kpiCli').textContent = clientes.toLocaleString('pt-BR');
    setDot(document.getElementById('dotCli'), 1); // N√£o tem m√©trica de status para Cliente

    document.getElementById('kpiTicket').textContent = fmtBR(ticketMedio);
    setDot(document.getElementById('dotTicket'), 1); // N√£o tem m√©trica de status para Ticket

    document.getElementById('kpiMargem').textContent = (margemPct * 100).toFixed(1) + '%';
    setDot(document.getElementById('dotMargem'), margemPct / 0.12); // Meta 12%

    document.getElementById('kpiMC').textContent = fmtBR(margemCont);
    document.getElementById('descMC').textContent = `Lucro Antes dos Fixos`;

    document.getElementById('kpiCAC').textContent = fmtBR(cac);
    setDot(document.getElementById('dotCAC'), 1 - (cac / (ticketMedio * 0.5))); // Meta CAC <= 50% do Ticket M√©dio (estimado)

    document.getElementById('kpiCustos').textContent = (custoPct * 100).toFixed(1) + '%';
    setDot(document.getElementById('dotCustos'), 1 - (custoPct / 0.15)); // Meta Custos <= 15%

    document.getElementById('kpiMeta').textContent = (metaPct * 100).toFixed(1) + '%';
    setDot(document.getElementById('dotMeta'), metaPct);

    // 2. Atualizar Trend Info (Varia√ß√£o Semanal)
    const trendEl = document.getElementById('trendInfo');
    const trendDesc = trend > 0 ? 'Subindo' : (trend < 0 ? 'Caindo' : 'Est√°vel');
    const trendFmt = (Math.abs(trend) * 100).toFixed(1) + '%';
    trendEl.textContent = `${trendFmt} (${trendDesc})`;
    trendEl.style.background = trend > 0.05 ? 'var(--ok)' : (trend < -0.05 ? 'var(--bad)' : 'var(--warn)');
    
    // 3. Atualizar Charts
    updateChartVendas(filtered);
    updateChartMargemCusto({margemPct, custoPct, custosTotais, fat});

    // 4. Atualizar Insights e Recomenda√ß√µes
    updateInsights({margemPct, metaPct, trend, cac, ticketMedio, lucro});
    
    // 5. Atualizar Rotina (tarefa foco)
    updateRotina({margemPct, metaPct, cac});

    // 6. Atualizar Log de A√ß√µes
    atualizarLogAcoes();
}

function updateChartVendas(data) {
    const dates = data.map(d => d.data.toLocaleDateString('pt-BR'));
    const valores = data.map(d => d.valor);

    if (chartVendas) chartVendas.destroy();

    const chartData = {
        labels: dates,
        datasets: [{
            label: 'Vendas Di√°rias (R$)',
            data: valores,
            borderColor: COR_AZUL,
            backgroundColor: 'rgba(42, 79, 218, 0.1)',
            fill: true,
            tension: 0.2,
            pointRadius: 0
        }]
    };

    chartVendas = new Chart(document.getElementById('chartVendas'), {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { beginAtZero: true, display: false }
            }
        }
    });
}

function updateChartMargemCusto({margemPct, custoPct, custosTotais, fat}) {
    if (chartMargemCusto) chartMargemCusto.destroy();

    const chartData = {
        labels: ['Sua Margem %', 'Seu Custo %'],
        datasets: [{
            label: 'Percentual',
            data: [margemPct * 100, custoPct * 100],
            backgroundColor: [COR_AZUL, COR_BAD],
            borderColor: [COR_AZUL, COR_BAD],
            borderWidth: 1
        }]
    };
    
    // A linha de refer√™ncia √© a meta de Margem (12%) e de Custo (100% - 12% = 88%)
    const lineMargin = 12; 
    const lineCost = 88;

    chartMargemCusto = new Chart(document.getElementById('chartMargemCusto'), {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: true },
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { callback: v => v + '%' },
                    // Linhas de refer√™ncia (Annotation plugin n√£o est√° inclu√≠do, fazemos com o padr√£o)
                    afterBuildTicks: axis => {
                        if (axis.id === 'y') {
                            axis.ticks.push({ value: lineMargin, label: 'Margem Ideal (12%)' });
                            axis.ticks.push({ value: lineCost, label: 'Custo M√°ximo (88%)' });
                        }
                    }
                }
            }
        }
    });
}

function updateInsights({margemPct, metaPct, trend, cac, ticketMedio, lucro}) {
    const insightsEl = document.getElementById('insights');
    const recosEl = document.getElementById('recos');
    insightsEl.innerHTML = '';
    recosEl.innerHTML = '';
    
    let insights = [];
    let recos = [];
    
    // L√≥gica dos Insights
    if (metaPct < 0.85) {
        insights.push({ type: 'bad', text: 'Meta em Risco:', detail: `Meta atingida em ${(metaPct * 100).toFixed(0)}%. √â necess√°rio acelerar.` });
        recos.push({ text: 'Acelerar Vendas:', detail: 'Foco no faturamento e ticket m√©dio.' });
    } else if (metaPct >= 0.95 && metaPct < 1.05) {
        insights.push({ type: 'warn', text: 'Reta Final:', detail: `Meta pr√≥xima! Atingiu ${(metaPct * 100).toFixed(0)}%.` });
        recos.push({ text: 'Manter Foco:', detail: 'Bater a meta e garantir a margem. Foco na qualidade da venda.' });
    } else if (metaPct >= 1.05) {
        insights.push({ type: 'ok', text: 'Meta Batida!', detail: `Parab√©ns! Foco em maximizar a margem de lucro.` });
        recos.push({ text: 'Maximizar Lucro:', detail: 'Bater a meta e garantir a margem. Foco na qualidade da venda.' });
    }

    if (margemPct < 0.10) {
        insights.push({ type: 'bad', text: 'Margem Apertada:', detail: `Margem de ${(margemPct * 100).toFixed(1)}%. Os custos est√£o muito altos ou o pre√ßo de venda est√° baixo.` });
        recos.push({ text: 'Revisar Custos/Pre√ßos:', detail: 'Simular redu√ß√£o de custos ou aumento de ticket.' });
    } else if (margemPct >= 0.10 && margemPct < 0.15) {
        insights.push({ type: 'warn', text: 'Margem OK, mas pode melhorar:', detail: `Margem de ${(margemPct * 100).toFixed(1)}%. Busque 15%+.` });
    } else {
        insights.push({ type: 'ok', text: 'Margem Saud√°vel:', detail: `Margem de ${(margemPct * 100).toFixed(1)}%. Opera√ß√£o eficiente.` });
    }
    
    if (trend < -0.05 && metaPct < 1.0) {
        insights.push({ type: 'bad', text: 'Queda de Vendas:', detail: `Tend√™ncia caindo ${(Math.abs(trend) * 100).toFixed(1)}% na √∫ltima semana. √â urgente reagir.` });
        recos.push({ text: 'A√ß√£o de Revers√£o:', detail: 'Promover o produto de maior margem ou fazer uma campanha r√°pida.' });
    } else if (trend > 0.05 && metaPct < 1.0) {
        insights.push({ type: 'ok', text: 'Tend√™ncia Forte:', detail: `Vendas subindo ${(trend * 100).toFixed(1)}%. Mantenha o foco.` });
    }
    
    if (cac > ticketMedio * 0.5 && cac > 0) {
        insights.push({ type: 'bad', text: 'CAC Elevado:', detail: `Custo/Cliente (${fmtBR(cac)}) √© alto em rela√ß√£o ao Ticket (${fmtBR(ticketMedio)}).` });
        recos.push({ text: 'Reduzir Custos Fixos:', detail: 'Revisar despesas de aluguel/servi√ßos para diminuir o CAC.' });
    }

    // Gera√ß√£o do HTML dos Insights
    insights.forEach(i => {
        insightsEl.innerHTML += `<div class="insight ${i.type}"><strong>${i.text}</strong><span>${i.detail}</span></div>`;
    });
    // Gera√ß√£o do HTML das Recomenda√ß√µes
    recos.forEach(r => {
        recosEl.innerHTML += `<div class="item"><strong>${r.text}</strong><br><span class="mut">${r.detail}</span></div>`;
    });
    
    if (insights.length === 0) {
        insightsEl.innerHTML = '<div class="insight ok"><strong>Tudo Certo!</strong><span>Seus KPIs est√£o dentro do esperado. Continue monitorando e use o Simulador.</span></div>';
    }
    if (recos.length === 0) {
        recosEl.innerHTML = '<div class="item mut" style="text-align:center;">Nenhuma a√ß√£o urgente no momento. Use o Simulador!</div>';
    }
}

function updateRotina({margemPct, metaPct, cac}) {
    const rotinaEl = document.getElementById('rotinaSugerida');
    const focoItem = rotinaEl.querySelector('.foco-item');
    
    // Remove o item de foco anterior, se existir
    if (focoItem) {
        focoItem.remove();
    }
    
    let focoText = '';
    
    if (margemPct < 0.10) {
        focoText = 'üö® Foco hoje: **Revisar e renegociar Custos** com fornecedores (Margem baixa).';
    } else if (cac > 0 && cac > (calcular().ticketMedio * 0.5)) {
        focoText = 'üö® Foco hoje: **Identificar e cortar 1 Custo Fixo** (CAC alto).';
    } else if (metaPct < 0.85) {
        focoText = 'üö® Foco hoje: **Criar 1 Promo√ß√£o rel√¢mpago** (Meta em risco).';
    } else {
        focoText = 'üö® Foco hoje: **Max. Lucro** - Vender o produto de maior margem.';
    }
    
    const novoFoco = document.createElement('li');
    novoFoco.className = 'foco-item';
    // Usamos replace para garantir que o texto em negrito seja renderizado como tal
    novoFoco.innerHTML = focoText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Insere o novo item de foco no in√≠cio da lista (ap√≥s o item de registro di√°rio)
    const dailyItem = rotinaEl.children[0]; 
    rotinaEl.insertBefore(novoFoco, dailyItem.nextSibling); 
}

// =========================================================================
// INICIALIZA√á√ÉO E EVENT LISTENERS
// =========================================================================

async function loadFromUrl(){
    const url = (elUrl.value||'').trim();
    if(!url){ alert('Cole a URL do CSV publicado (precisa terminar com output=csv).'); return; }
    try{
        const txt = await fetchCSV(url);
        const rows = csvToRows(txt);
        DATA = hydrate(rows);
        atualizar();
    }catch(e){
        console.error(e);
        alert('N√£o foi poss√≠vel ler o CSV. Confira a URL (precisa terminar com output=csv).');
    }
}

function loadFromFile(file){
    const reader = new FileReader();
    reader.onload = e => {
        try{
            const rows = csvToRows(e.target.result);
            DATA = hydrate(rows);
            atualizar();
        }catch(err){
            console.error(err);
            alert('Arquivo inv√°lido. Verifique os cabe√ßalhos.');
        }
    };
    reader.readAsText(file, 'utf-8');
}

// SIMULADOR LISTENERS
const elSimTicket = document.getElementById('simTicket');
const elSimClientes = document.getElementById('simClientes');
const elSimCustos = document.getElementById('simCustos');

function atualizarSimulador() {
    if (DATA.length === 0) return;
    
    const simTicket = parseInt(elSimTicket.value);
    const simClientes = parseInt(elSimClientes.value);
    const simCustos = parseInt(elSimCustos.value);
    
    // Atualizar badges
    document.getElementById('simTicketVal').textContent = `+R$${simTicket}`;
    document.getElementById('simClientesVal').textContent = `+${simClientes}`;
    document.getElementById('simCustosVal').textContent = `-${simCustos}%`;
    
    // Calcular simula√ß√£o
    const { simular } = calcular();
    const { novoFat, novoLucro, novaMargemPct, novaMetaPct } = simular(simTicket, simClientes, simCustos);

    const resultadoEl = document.getElementById('simResultado');
    resultadoEl.innerHTML = `
        üìä Resultado simulado: 
        <strong>${fmtBR(novoLucro)}</strong> (Lucro) ‚Ä¢ 
        <strong>${(novaMargemPct * 100).toFixed(1)}%</strong> (Margem) ‚Ä¢ 
        <strong>${(novaMetaPct * 100).toFixed(0)}%</strong> (Meta)
    `;
    resultadoEl.style.backgroundColor = novaMetaPct >= 1.05 ? 'var(--ok)' : novaMetaPct >= 0.95 ? 'var(--warn)' : 'var(--bad)';
    resultadoEl.style.color = 'white';
}

elSimTicket.addEventListener('input', atualizarSimulador);
elSimClientes.addEventListener('input', atualizarSimulador);
elSimCustos.addEventListener('input', atualizarSimulador);


// LISTENERS PRINCIPAIS
document.getElementById('btnCarregar').addEventListener('click', loadFromUrl);
elFile.addEventListener('change', ev => { if(ev.target.files && ev.target.files[0]) loadFromFile(ev.target.files[0]); });
['change','keyup'].forEach(ev => { elMeta.addEventListener(ev, atualizar); elPeriod.addEventListener(ev, atualizar); });

// LISTENERS DE A√á√ÉO
document.getElementById('btnRegistrar').addEventListener('click', ()=>generateActionPlan({tipo:'manual'}));
document.getElementById('btnMeta').addEventListener('click', ()=>alert('Atualize o campo Meta Mensal no topo e os KPIs ser√£o recalculados.'));
document.getElementById('btnPlano').addEventListener('click', ()=> generateActionPlan({ tipo:'simulacao' }));
document.getElementById('btnLembrete').addEventListener('click', createWeeklyICS);
document.getElementById('btnForm').addEventListener('click', openDailyForm);

// Inicializa√ß√£o: Tenta carregar dados do localStorage e atualizar o log
document.addEventListener('DOMContentLoaded', () => {
    // Tenta carregar URL salva
    const savedUrl = localStorage.getItem('pme_csv_url');
    if (savedUrl) {
        elUrl.value = savedUrl;
        loadFromUrl(); // Tenta carregar automaticamente
    }
    // Salva a URL ao carregar
    document.getElementById('btnCarregar').addEventListener('click', () => {
        const url = elUrl.value.trim();
        if (url) {
            localStorage.setItem('pme_csv_url', url);
        }
    });

    atualizarLogAcoes();
    if (DATA.length > 0) {
        atualizarSimulador(); // Inicializa o simulador se houver dados
    } else {
        // Estado inicial do simulador quando n√£o h√° dados
        document.getElementById('simResultado').textContent = 'üìä Resultado simulado: Carregue os dados primeiro.';
    }
});
</script>
</body>
</html>
