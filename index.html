<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PME Inteligente: GestÃ£o Simplificada 360Â°</title> 
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--azul:#2a4fda;--atl:#0b2574;--off:#eff3ee;--bg:#ffffff;--txt:#0f172a;--mut:#64748b;--b:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;--shadow:0 8px 24px rgba(2,6,23,.06)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--txt)}
header{background:linear-gradient(90deg,var(--azul),var(--atl));color:#fff;padding:22px 18px;box-shadow:var(--shadow); text-align: center;}
h1{margin:0;font-weight:800;letter-spacing:-.3px}
small{opacity:.9}
.container{max-width:1200px;margin:18px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--b);border-radius:18px;box-shadow:var(--shadow);padding:14px}
.grid{display:grid;gap:14px}
@media(min-width:920px){.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:2fr 1fr}.cols-2e{grid-template-columns:1fr 1fr}}
.toolbar{display:flex;flex-wrap:wrap;gap:10px}
.input,select,button{border:1px solid var(--b);border-radius:12px;padding:10px 12px;background:#fff}
label{font-size:13px;color:var(--mut)}
.pill{display:flex;align-items:center;gap:10px;border:1px solid var(--b);border-radius:999px;background:var(--off);padding:8px 12px}
.badge{font-size:12px;border:1px solid var(--b);border-radius:999px;padding:5px 10px;background:var(--off);color:#111}
.kpi{display:flex;gap:10px;align-items:flex-start}
.kpi .dot{width:14px;height:14px;border-radius:50%}
.kpi h3{margin:0;font-size:13px;color:var(--mut)}
.kpi .value{font-size:28px;font-weight:800;letter-spacing:-.4px}
.hint{font-size:12px;color:var(--mut);margin-top:6px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.legend{display:flex;gap:10px;flex-wrap:wrap}
.legend span{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--mut)}
.legend i{width:10px;height:10px;border-radius:2px;display:inline-block}
.insights{display:grid;gap:10px}
@media(min-width:900px){.insights{grid-template-columns:1fr 1fr}}
.insight{border-left:6px solid var(--azul);background:#f8fafc;border:1px solid var(--b);padding:10px 12px;border-radius:12px}
.insight strong{display:block;margin-bottom:4px}
.insight.warn{border-left-color:var(--warn);background:#fff7ed}
.insight.bad{border-left-color:var(--bad);background:#fef2f2}
.insight.ok{border-left-color:var(--ok);background:#f0fdf4}
.item{border:1px solid var(--b);border-radius:12px;padding:10px;background:#fafafa}
.list{display:grid;gap:10px}
code{background:#f1f5f9;border:1px solid var(--b);padding:2px 6px;border-radius:6px}
hr{border:none;border-top:1px solid var(--b);margin:8px 0}
footer{padding:24px;color:#6b7280;text-align:center}
.hidden{display:none !important}
.range{display:grid;gap:6px}
.range label{font-size:12px;color:var(--mut)}
.range input{width:100%}
.mut{color:#6b7280;font-size:12px}

/* Estilos para o Guia Incorporado */
#guia-content h2 {color: var(--atl); font-size: 1.5em; margin-top: 1em;}
#guia-content ul, #guia-content ol {padding-left: 20px;}
#guia-content ul li, #guia-content ol li {margin-bottom: 8px; line-height: 1.5;}
.guia-toggle {cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; font-weight: 600;}
.guia-toggle i {transition: transform 0.3s;}
.collapsed i {transform: rotate(-90deg);}
</style>
</head>
<body>
<header>
  <h1>PME Inteligente: GestÃ£o Simplificada 360Â°</h1>
  <small>InteligÃªncia de Dados para o Seu Dia a Dia.</small> 
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div class="toolbar" style="flex-wrap:wrap">
        <input id="csvUrl" class="input" style="min-width:420px" placeholder="Cole aqui a URL CSV do seu Google Sheets...">
        <button id="btnCarregar">Carregar Dados</button>
        <input id="fileInput" class="input" type="file" accept=".csv">
        <button id="btnAbrirGuia" class="input" style="background:var(--off)">Abrir Guia RÃ¡pido ğŸ“š</button> <!-- NOVO BOTÃƒO -->
        <div class="pill">
          <label>PerÃ­odo</label>
          <select id="period"><option value="30">Ãšltimos 30 dias</option><option value="90">Ãšltimos 90 dias</option><option value="365">Ãšltimos 12 meses</option></select>
        </div>
        <div class="pill">
          <label>Meta mensal (R$)</label>
          <input id="meta" class="input" type="number" step="100" value="15000">
        </div>
      </div>
      <div class="row" style="gap:8px">
        <button id="btnRegistrar" class="input">Registrar aÃ§Ã£o</button>
        <button id="btnMeta" class="input">Atualizar meta</button>
      </div>
    </div>
  </div>

  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotFat" class="dot"></span><div><h3>ğŸ’° Faturamento (perÃ­odo)</h3><div id="kpiFat" class="value">â€”</div><div id="descFat" class="hint">â€”</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotCli" class="dot"></span><div><h3>ğŸ‘¥ Clientes</h3><div id="kpiCli" class="value">â€”</div><div id="descCli" class="hint">â€”</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotTicket" class="dot"></span><div><h3>ğŸ§¾ Ticket mÃ©dio</h3><div id="kpiTicket" class="value">â€”</div><div id="descTicket" class="hint">â€”</div></div></div></div>
  </section>
  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotMargem" class="dot"></span><div><h3>ğŸ“ˆ Margem (%)</h3><div id="kpiMargem" class="value">â€”</div><div id="descMargem" class="hint">â€”</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotMC" class="dot" style="background:var(--azul)"></span><div><h3>ğŸ’¸ Margem ContribuiÃ§Ã£o</h3><div id="kpiMC" class="value">â€”</div><div id="descMC" class="hint">â€”</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotCAC" class="dot" style="background:var(--warn)"></span><div><h3>ğŸ‘¤ Custo/Cliente (CAC)</h3><div id="kpiCAC" class="value">â€”</div><div id="descCAC" class="hint">â€”</div></div></div></div>
  </section>
  <section class="grid cols-3" style="margin-top:14px">
    <div class="card"><div class="kpi"><span id="dotCustos" class="dot"></span><div><h3>ğŸ’¼ Custos (% vendas)</h3><div id="kpiCustos" class="value">â€”</div><div id="descCustos" class="hint">â€”</div></div></div></div>
    <div class="card"><div class="kpi"><span id="dotMeta" class="dot"></span><div><h3>ğŸ¯ Meta atingida (%)</h3><div id="kpiMeta" class="value">â€”</div><div id="descMeta" class="hint">â€”</div></div></div></div>
  </section>

  <section class="grid cols-2" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>EvoluÃ§Ã£o semanal de vendas</strong><span id="trendInfo" class="badge">â€”</span></div>
      <canvas id="chartVendas" height="120"></canvas>
    </div>
    <div class="card">
      <div class="row"><strong>Desempenho de Margem e Custo (Lucratividade)</strong><span class="badge">Ãšltimos PerÃ­odos</span></div>
      <canvas id="chartMargemCusto" height="120"></canvas>
    </div>
  </section>

  <section class="grid cols-2e" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>ğŸ” O que os dados dizem agora</strong><span class="mut">(gerado automaticamente)</span></div>
      <div id="insights" class="insights" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="row"><strong>ğŸ§­ O que vocÃª pode fazer</strong><span class="mut">(recomendaÃ§Ãµes prÃ¡ticas)</span></div>
      <div id="recos" class="list" style="margin-top:10px"></div>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row"><strong>ğŸ§ª Simulador â€œe se euâ€¦â€</strong><span class="mut">(impacto estimado no mÃªs)</span></div>
    <div class="grid cols-3" style="margin-top:8px">
      <div class="range">
        <label>âœï¸ Ajustar ticket mÃ©dio (+R$) <span id="simTicketVal" class="badge">+0</span></label>
        <input id="simTicket" type="range" min="0" max="10" step="1" value="0">
      </div>
      <div class="range">
        <label>ğŸ“£ Aumentar clientes/dia (+) <span id="simClientesVal" class="badge">+0</span></label>
        <input id="simClientes" type="range" min="0" max="20" step="1" value="0">
      </div>
      <div class="range">
        <label>ğŸ”§ Reduzir custos (%) <span id="simCustosVal" class="badge">0%</span></label>
        <input id="simCustos" type="range" min="0" max="10" step="1" value="0">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div id="simResultado" class="pill">ğŸ“Š Resultado simulado: â€”</div>
      <button id="btnPlano" class="input">Gerar plano de aÃ§Ã£o</button>
    </div>
  </section>

  <section class="grid cols-2e" style="margin-top:14px">
    <div class="card">
      <div class="row"><strong>ğŸ“… Ãšltimas aÃ§Ãµes registradas</strong><span id="logInfo" class="mut">â€”</span></div>
      <div class="list" style="margin-top:10px" id="logAcoes">
        <!-- ConteÃºdo agora Ã© injetado pelo JavaScript -->
      </div>
    </div>
    <div class="card">
      <div class="row"><strong>â° Rotina sugerida</strong><span class="mut">(para criar hÃ¡bito)</span></div>
      <ul id="rotinaSugerida">
        <!-- O item dinÃ¢mico serÃ¡ injetado aqui -->
        <li>Diariamente (19h): registrar vendas (30s)</li>
        <li>Segunda: revisar painel e definir 1 aÃ§Ã£o</li>
        <li>Ãšltimo dia do mÃªs: ajustar meta</li>
      </ul>
      <div class="row" style="gap:8px"><button id="btnLembrete" class="input">Criar lembrete</button><button id="btnForm" class="input">Abrir formulÃ¡rio diÃ¡rio</button></div>
    </div>
  </section>

  <!-- NOVO CARD: GUIA RÃPIDO INCORPORADO -->
  <section class="card" style="margin-top:14px;">
    <div id="guiaToggle" class="guia-toggle" onclick="toggleGuia()">
        <span>Guia RÃ¡pido: Como Usar o Painel ğŸ“š</span>
        <i style="font-style: normal; font-weight: bold; font-size: 1.2em;">â–¼</i>
    </div>
    <div id="guiaContent" style="display:none; margin-top: 15px;">
        <hr>
        <div id="guia-content">
            <!-- CONTEÃšDO DO GUIA v2.3 INJETADO AQUI -->
            
            <h2>1ï¸âƒ£ O que Ã© o seu Painel de AÃ§Ã£o?</h2>
            <ul>
              <li>Ã‰ uma ferramenta HTML leve, focada em transformar sua planilha de vendas em aÃ§Ãµes prÃ¡ticas.</li>
              <li>Gera recomendaÃ§Ãµes especÃ­ficas e permite simular o impacto das decisÃµes antes de executÃ¡-las.</li>
              <li>Ã‰ seu diÃ¡rio de bordo: rastreia seu progresso em atingir a meta e monitora suas aÃ§Ãµes de melhoria.</li>
            </ul>
            
            <h2>2ï¸âƒ£ Como Iniciar e Alimentar o Painel</h2>
            <ol>
              <li><strong>ConexÃ£o de Dados:</strong> Cole o link **CSV** da sua Planilha Google no campo superior do Painel e clique em <span class="badge">Carregar Dados</span>.</li>
              <li><strong>Registro DiÃ¡rio:</strong> Use o botÃ£o <span class="badge">Abrir formulÃ¡rio diÃ¡rio</span> para registrar suas vendas e custos (30 segundos).</li>
              <li><strong>AtualizaÃ§Ã£o:</strong> Sempre que quiser ver os nÃºmeros atualizados, clique em <span class="badge">Carregar Dados</span> novamente.</li>
            </ol>
            <p class="badge">Dica: O painel usa a meta mais recente registrada na planilha ou a meta que vocÃª inserir manualmente no campo do topo.</p>
            
            <h2>3ï¸âƒ£ Foco na DecisÃ£o: Insights e Simulador</h2>
            <ul>
              <li><strong>ğŸ” O que os dados dizem:</strong> Analisa Margem, Meta, RecorrÃªncia e TendÃªncia para identificar problemas (<span style="color:var(--bad);font-weight:600">Vermelho</span>), alertas (<span style="color:var(--warn);font-weight:600">Amarelo</span>) e acertos (<span style="color:var(--ok);font-weight:600">Verde</span>).</li>
              <li><strong>ğŸ§­ O que vocÃª pode fazer:</strong> Oferece sugestÃµes concretas (Ex: Max. Lucro, Planejamento, Aumentar Ticket). Use o botÃ£o <span class="badge">Criar aÃ§Ã£o</span> para gerar um Plano de AÃ§Ã£o (.txt) e registrar no seu log.</li>
              <li><strong>ğŸ§ª Simulador:</strong> Teste o impacto de aumentar o Ticket ou Clientes, ou reduzir Custos. O resultado (Faturamento/Margem/Meta) Ã© calculado instantaneamente.</li>
            </ul>
            
            <h2>4ï¸âƒ£ Indicadores-chave: O GlossÃ¡rio Completo</h2>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;">
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ’° Faturamento</strong><br><span>Soma do Valor total de vendas no perÃ­odo.</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ‘¥ Clientes</strong><br><span>Total de clientes que compraram no perÃ­odo.</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ§¾ Ticket mÃ©dio</strong><br><span>MÃ©dia gasta por cliente (Faturamento Ã· Clientes).</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ“ˆ Margem (%)</strong><br><span>Seu lucro percentual (apÃ³s todos os custos). Alvo ideal: acima de 12%.</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ’¸ Margem ContribuiÃ§Ã£o</strong><br><span>O que sobra da venda para pagar os Custos Fixos. Essencial para decidir sobre promoÃ§Ãµes.</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ‘¤ Custo/Cliente (CAC)</strong><br><span>Custo Fixo dividido por cliente. Monitore a eficiÃªncia da sua estrutura.</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ’¼ Custos (% vendas)</strong><br><span>O percentual da sua receita gasto com custos (Custos Totais Ã· Faturamento).</span></div>
              <div style="border:1px solid var(--b);border-radius:12px;padding:12px;background:#fafafa;"><strong>ğŸ¯ Meta atingida (%)</strong><br><span>Seu progresso em relaÃ§Ã£o Ã  Meta Mensal.</span></div>
            </div>
            
            <h2>5ï¸âƒ£ O Que Cada GrÃ¡fico Te Diz</h2>
            <ul>
              <li><strong>EvoluÃ§Ã£o Semanal/PerÃ­odo:</strong> Mostra se vocÃª estÃ¡ vendendo mais ou menos que no perÃ­odo anterior. Se a linha estiver subindo (tendÃªncia positiva), reforce o estoque do item mais vendido!</li>
              <li><strong>Desempenho de Margem e Custo:</strong> Ã‰ seu termÃ´metro financeiro. Ele te diz:
                <ul>
                  <li>Se a barra <span style="color:var(--azul);font-weight:600">Azul</span> (Margem) estÃ¡ acima da linha amarela de 12%, sua operaÃ§Ã£o estÃ¡ saudÃ¡vel.</li>
                  <li>Se a barra <span style="color:var(--bad);font-weight:600">Vermelha</span> (Custos) estÃ¡ abaixo da linha amarela de 88%, seus custos estÃ£o sob controle.</li>
                </ul>
              </li>
            </ul>
            
            <h2>6ï¸âƒ£ Rotina de GestÃ£o (ManutenÃ§Ã£o do HÃ¡bito)</h2>
            <ol>
              <li><strong>ğŸš¨ Tarefa Foco:</strong> O primeiro item da lista na seÃ§Ã£o Rotina Sugerida Ã© a aÃ§Ã£o mais crÃ­tica do dia, baseada nos seus resultados atuais.</li>
              <li><strong>Cultura DiÃ¡ria:</strong> Preencher o formulÃ¡rio (30s).</li>
              <li><strong>Cultura Semanal:</strong> Toda segunda, revisar o painel e definir 1 aÃ§Ã£o de melhoria.</li>
              <li><strong>Cultura Mensal:</strong> Ajustar a meta para o prÃ³ximo ciclo.</li>
              <li>Use <span class="badge">Criar lembrete</span> para agendar a rotina semanal no seu calendÃ¡rio.</li>
            </ol>
            
        </div>
    </div>
  </section>
</div>

<footer>
  Â© 2025 Painel PME Inteligente - Grupo 3 (Julio Volpatto, Rodrigo Santos e Mariana Santana)
</footer>

<script>
let DATA=[], chartVendas=null, chartMargemCusto=null; 
const elUrl = document.getElementById('csvUrl');
const elMeta = document.getElementById('meta');
const elPeriod = document.getElementById('period');
const elFile = document.getElementById('fileInput');

// Cores HEX da paleta (para Chart.js)
const COR_AZUL = '#2a4fda'; // --azul
const COR_BAD = '#dc2626';  // --bad
const COR_WARN = '#f59e0b'; // --warn

// LÃ³gica de armazenamento local para AÃ§Ãµes Registradas
function carregarAcoes() {
    try {
        const json = localStorage.getItem('pme_acoes');
        return json ? JSON.parse(json) : [];
    } catch (e) {
        console.error("Erro ao carregar aÃ§Ãµes:", e);
        return [];
    }
}

function salvarAcao(acao) {
    const acoes = carregarAcoes();
    acao.id = Date.now();
    acao.data = new Date().toLocaleDateString('pt-BR');
    acao.status = 'em execuÃ§Ã£o';
    acoes.unshift(acao); 
    localStorage.setItem('pme_acoes', JSON.stringify(acoes.slice(0, 5))); // Guarda apenas as 5 mais recentes
}

function removerAcao(id) {
    let acoes = carregarAcoes();
    // Simplesmente remove a aÃ§Ã£o
    acoes = acoes.filter(acao => acao.id != id);
    localStorage.setItem('pme_acoes', JSON.stringify(acoes));
    atualizarLogAcoes();
}

function atualizarLogAcoes() {
    const logAcoesEl = document.getElementById('logAcoes');
    const acoes = carregarAcoes();
    logAcoesEl.innerHTML = '';
    
    if (acoes.length === 0) {
        logAcoesEl.innerHTML = '<div class="item mut" style="text-align:center;">Nenhuma aÃ§Ã£o registrada ainda.</div>';
        document.getElementById('logInfo').textContent = '(Vazio)';
        return;
    }

    acoes.forEach(acao => {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        // Adiciona o botÃ£o de remoÃ§Ã£o/conclusÃ£o
        const statusText = acao.status === 'em execuÃ§Ã£o' ? '<span class="badge" style="background:var(--warn)">Em ExecuÃ§Ã£o</span>' : '<span class="badge" style="background:var(--ok)">ConcluÃ­do</span>';
        
        itemEl.innerHTML = `
            <div class="row">
                <strong>${acao.nome}</strong>
                <button class="input" style="padding: 4px 8px; font-size: 11px;" onclick="removerAcao(${acao.id})">Remover/Concluir</button>
            </div>
            <div class="hint" style="margin-top:4px; font-size: 11px;">Iniciado ${acao.data} â€¢ Status: ${acao.status}</div>
        `;
        logAcoesEl.appendChild(itemEl);
    });
    document.getElementById('logInfo').textContent = `(Total: ${acoes.length} aÃ§Ãµes)`;
}

// Helpers
function parseNumberBR(s){
  if (typeof s === 'number') return s;
  if (!s) return 0;
  const t = (''+s).trim().replace(/\s/g,''); 
  const norm = t.match(/,\d{1,2}$/) ? t.replace(/\./g,'').replace(',', '.') : t;
  const v = parseFloat(norm);
  return isNaN(v) ? 0 : v;
}
function fmtBR(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }
function setDot(el, pct){ el.style.background = pct>=0.95? 'var(--ok)' : pct>=0.85? 'var(--warn)' : 'var(--bad)'; }
function csvToRows(csv){
  const rows=[]; let i=0, field=''; let row=[]; let quoted=false; 
  const s=csv.replace(/\r/g,''); 
  while(i<s.length){
    const c=s[i];
    if(c==='\"'){ if(quoted && s[i+1]==='\"'){ field+='\"'; i++; } else { quoted=!quoted; } }
    else if(c===',' && !quoted){ row.push(field); field=''; }
    else if(c==='\n' && !quoted){ row.push(field); rows.push(row); row=[]; field=''; }
    else { field+=c; }
    i++;
  }
  if(field.length||row.length){ row.push(field); rows.push(row); }
  return rows;
}
async function fetchCSV(url){ const res = await fetch(url); if(!res.ok) throw new Error('Falha ao acessar CSV'); return await res.text(); }

function parseDateBR(dateStr){
    if (!dateStr || dateStr.length < 8) return null;
    // Tenta DD/MM/AAAA (padrÃ£o brasileiro)
    if (dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/)) {
        const parts = dateStr.split('/');
        // JS usa Date(YYYY, MM-1, DD)
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    // Tenta AAAA-MM-DD ou formato ISO (padrÃ£o universal/CSV)
    const d = new Date(dateStr);
    return isNaN(d.getTime()) ? null : d;
}

function hydrate(rows){
  const head = rows.shift().map(h=>h.trim());
  const idx = {
    Data: head.indexOf('Data'), Valor: head.indexOf('Valor'), Clientes: head.indexOf('Clientes'),
    Produto: head.indexOf('Produto'), Categoria: head.indexOf('Categoria'),
    CF: head.indexOf('CustosFixos'), CV: head.indexOf('CustosVariaveis'), MetaMensal: head.indexOf('MetaMensal')
  };
  const arr = rows.map(r=>({
    data: parseDateBR(r[idx.Data]),
    valor: parseNumberBR(r[idx.Valor]),
    clientes: parseInt(r[idx.Clientes]||'0',10)||0,
    produto: idx.Produto>=0? r[idx.Produto] : '',
    categoria: idx.Categoria>=0? r[idx.Categoria] : '',
    cf: idx.CF>=0? parseNumberBR(r[idx.CF]) : null,
    cv: idx.CV>=0? parseNumberBR(r[idx.CV]) : null,
    metaRow: idx.MetaMensal>=0? parseNumberBR(r[idx.MetaMensal]) : null
  })).filter(x=>x.data && !isNaN(x.data.getTime())); 
  
  return arr.sort((a,b)=>a.data-b.data);
}

// =========================================================================
// FUNÃ‡Ã•ES DE AÃ‡ÃƒO (MOVIDAS PARA O INÃCIO PARA RESOLVER O ReferenceError)
// =========================================================================

function createWeeklyICS(){
  const now = new Date();
  const day = now.getDay(); // 0=dom
  const diff = ((1 - day + 7) % 7) || 7; 
  const nextMon = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff, 9, 0, 0);
  function toICSDate(d){
    const pad = n => String(n).padStart(2,'0');
    return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate()) + 'T' + pad(d.getUTCHours()) + pad(d.getUTCM
